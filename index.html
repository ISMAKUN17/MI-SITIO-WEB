<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservas</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-5">
    <h1>Reservas</h1>
    <form id="reservaForm">
        <div class="form-row">
            <div class="form-group col-md-4">
                <label for="dateInput">Fecha</label>
                <input type="date" class="form-control" id="dateInput" required>
            </div>
            <div class="form-group col-md-4">
                <label for="roomInput">Habitación</label>
                <input type="text" class="form-control" id="roomInput" required>
            </div>
            <div class="form-group col-md-4">
                <label for="nameInput">Nombre</label>
                <input type="text" class="form-control" id="nameInput" required>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-4">
                <label for="placeSelect">Lugar</label>
                <select class="form-control" id="placeSelect" required>
                    <option value="">Seleccione</option>
                    <option value="Lugar 1">Lugar 1</option>
                    <option value="Lugar 2">Lugar 2</option>
                    <!-- Agregar más lugares según sea necesario -->
                </select>
            </div>
            <div class="form-group col-md-4">
                <label for="timeSelect">Hora</label>
                <input type="time" class="form-control" id="timeSelect" required>
            </div>
            <div class="form-group col-md-4">
                <label for="paxInput">Pax</label>
                <input type="number" class="form-control" id="paxInput" min="1" max="8" required>
            </div>
        </div>
        <div class="form-group">
            <label for="notesInput">Notas</label>
            <textarea class="form-control" id="notesInput"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Agregar Reserva</button>
    </form>
    <h2 class="mt-5">Lista de Reservas</h2>
    <input type="text" id="searchInput" placeholder="Buscar..." class="form-control mb-3">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Habitación</th>
                <th>Nombre</th>
                <th>Lugar</th>
                <th>Hora</th>
                <th>Pax</th>
                <th>Notas</th>
            </tr>
        </thead>
        <tbody id="reservasList"></tbody>
    </table>

    <!-- Modal -->
    <div class="modal fade" id="reservaModal" tabindex="-1" role="dialog" aria-labelledby="reservaModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reservaModalLabel">Detalles de la Reserva</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="modalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="availablePaxDisplay" class="mt-3"></div>
</div>

<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "firebase/app";
    import { getDatabase, ref, onValue, push } from "firebase/database";

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDUirwoSQgvcMZn7uLjKMAxlTA15Jkl2BM",
        authDomain: "ismakun-bf0fa.firebaseapp.com",
        databaseURL: "https://ismakun-bf0fa-default-rtdb.firebaseio.com",
        projectId: "ismakun-bf0fa",
        storageBucket: "ismakun-bf0fa.appspot.com",
        messagingSenderId: "1028877703945",
        appId: "1:1028877703945:web:331de48acbcdf2234a51d8"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const form = document.getElementById('reservaForm');
    const reservasList = document.getElementById('reservasList');
    const dateInput = document.getElementById('dateInput');
    const roomInput = document.getElementById('roomInput');
    const nameInput = document.getElementById('nameInput');
    const placeSelect = document.getElementById('placeSelect');
    const timeSelect = document.getElementById('timeSelect');
    const paxInput = document.getElementById('paxInput');
    const notesInput = document.getElementById('notesInput');
    const availablePaxDisplay = document.getElementById('availablePaxDisplay');
    const searchInput = document.getElementById('searchInput');
    const modalBody = document.getElementById('modalBody');

    function actualizarDisponibilidad() {
        const date = dateInput.value;
        const room = roomInput.value;
        const place = placeSelect.value;
        const time = timeSelect.value;

        const reservasRef = ref(db, 'reservas/' + date + '/' + room);
        onValue(reservasRef, (snapshot) => {
            const reservas = snapshot.val();
            const totalPax = reservas ? Object.values(reservas).reduce((sum, reserva) => sum + reserva.pax, 0) : 0;
            const availablePax = 8 - totalPax; // Cambiar aquí la capacidad total

            availablePaxDisplay.textContent = `Pax disponibles: ${availablePax}`;

            if (time) {
                const horasReservadas = Object.values(reservas).filter(reserva => reserva.hora === time).reduce((sum, reserva) => sum + reserva.pax, 0);
                const availableForTime = 8 - horasReservadas; // Cambiar aquí la capacidad total
                availablePaxDisplay.textContent += ` | Pax disponibles para ${time}: ${availableForTime}`;
            }
        });
    }

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const reserva = {
            fecha: dateInput.value,
            habitacion: roomInput.value,
            nombre: nameInput.value,
            lugar: placeSelect.value,
            hora: timeSelect.value,
            pax: parseInt(paxInput.value),
            notas: notesInput.value || "Sin notas"
        };

        const reservasRef = ref(db, 'reservas/' + reserva.fecha + '/' + reserva.habitacion);
        push(reservasRef, reserva);

        form.reset();
        actualizarDisponibilidad();
    });

    onValue(ref(db, 'reservas'), (snapshot) => {
        reservasList.innerHTML = '';
        const reservasData = snapshot.val();
        if (reservasData) {
            Object.entries(reservasData).forEach(([fecha, habitaciones]) => {
                Object.entries(habitaciones).forEach(([habitacion, reserva]) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${reserva.fecha}</td>
                        <td>${reserva.habitacion}</td>
                        <td>${reserva.nombre}</td>
                        <td>${reserva.lugar}</td>
                        <td>${reserva.hora}</td>
                        <td>${reserva.pax}</td>
                        <td>${reserva.notas}</td>
                    `;
                    tr.addEventListener('click', () => {
                        mostrarDetallesReserva(reserva);
                    });
                    reservasList.appendChild(tr);
                });
            });
        }
    });

    function mostrarDetallesReserva(reserva) {
        modalBody.innerHTML = `
            <p><strong>Fecha:</strong> ${reserva.fecha}</p>
            <p><strong>Habitación:</strong> ${reserva.habitacion}</p>
            <p><strong>Nombre:</strong> ${reserva.nombre}</p>
            <p><strong>Lugar:</strong> ${reserva.lugar}</p>
            <p><strong>Hora:</strong> ${reserva.hora}</p>
            <p><strong>Pax:</strong> ${reserva.pax}</p>
            <p><strong>Notas:</strong> ${reserva.notas}</p>
        `;
        $('#reservaModal').modal('show');
    }

    searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase();
        const rows = reservasList.getElementsByTagName('tr');
        Array.from(rows).forEach(row => {
            const cells = row.getElementsByTagName('td');
            const match = Array.from(cells).some(cell => cell.textContent.toLowerCase().includes(query));
            row.style.display = match ? '' : 'none';
        });
    });

    // Llama a la función al cargar la página
    actualizarDisponibilidad();
</script>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.7/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
